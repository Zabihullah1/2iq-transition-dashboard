<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2iQ AI Transition Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --accent: #1a56db;
  --accent-light: #e8effd;
  --danger: #dc2626;
  --danger-light: #fef2f2;
  --danger-border: #fecaca;
  --success: #059669;
  --success-light: #ecfdf5;
  --warn: #d97706;
  --warn-light: #fffbeb;
  --text: #1f2937;
  --text-mid: #4b5563;
  --text-light: #9ca3af;
  --border: #e5e7eb;
  --font: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: var(--font); background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.5; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #c1c7cf; border-radius: 3px; }

/* Header */
.header {
  background: linear-gradient(135deg, #0f2440 0%, #1a3f6f 50%, #1a56db 100%);
  padding: 20px 28px 0;
  color: #fff;
  position: sticky; top: 0; z-index: 100;
}
.header-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
.header h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.03em; margin: 0; }
.header .subtitle { font-size: 13px; opacity: 0.7; margin-top: 3px; }
.export-btn {
  font-family: var(--font); font-size: 12px; font-weight: 600; padding: 8px 18px;
  border-radius: 8px; border: 2px solid rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.08); color: #fff; cursor: pointer;
  backdrop-filter: blur(4px); transition: all 0.2s; display: flex; align-items: center; gap: 6px;
}
.export-btn:hover { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.5); }

/* Tabs */
.tabs { display: flex; gap: 2px; margin-top: 16px; overflow-x: auto; padding-bottom: 0; }
.tab {
  font-family: var(--font); font-size: 13px; font-weight: 500; padding: 10px 18px;
  border: none; cursor: pointer; background: transparent; color: rgba(255,255,255,0.6);
  border-radius: 10px 10px 0 0; transition: all 0.2s; white-space: nowrap;
}
.tab:hover { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.06); }
.tab.active { color: var(--text); background: var(--bg); font-weight: 700; }

/* Main content */
.main { padding: 20px 28px 40px; max-width: 1280px; margin: 0 auto; }

/* Cards */
.card {
  background: var(--card); border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  border: 1px solid var(--border); overflow: hidden;
}
.card-header {
  padding: 14px 18px; border-bottom: 1px solid var(--border);
  background: #f8fafc; display: flex; justify-content: space-between; align-items: center;
}
.card-header h3 { font-size: 14px; font-weight: 700; margin: 0; }
.card-body { padding: 18px; }

/* Stat cards */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--card); border-radius: 12px; padding: 18px; text-align: center;
  border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  transition: transform 0.2s, box-shadow 0.2s; }
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.stat-value { font-size: 30px; font-weight: 800; letter-spacing: -0.03em; }
.stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); margin-top: 2px; font-weight: 600; }

/* Tables */
table { width: 100%; border-collapse: collapse; }
th { padding: 10px 14px; text-align: left; font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--text-light); font-weight: 600; border-bottom: 2px solid var(--border); }
td { padding: 10px 14px; border-bottom: 1px solid var(--border); }
tr.clickable { cursor: pointer; transition: background 0.15s; }
tr.clickable:hover { background: var(--accent-light); }
tr.key-row { background: var(--success-light); }

/* Badges */
.badge {
  font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 12px;
  display: inline-block; white-space: nowrap;
}
.badge-off { background: var(--danger); color: #fff; }
.badge-high { background: var(--success-light); color: var(--success); }
.badge-medium { background: var(--warn-light); color: var(--warn); }
.badge-done { background: var(--accent-light); color: var(--accent); }
.badge-p1 { background: #fef2f2; color: var(--danger); }
.badge-p2 { background: #fff7ed; color: var(--warn); }
.badge-p3 { background: #f9fafb; color: var(--text-light); }

/* Project pills */
.proj-tabs { display: flex; gap: 6px; margin-bottom: 18px; flex-wrap: wrap; }
.proj-tab {
  font-family: var(--font); font-size: 12px; font-weight: 500; padding: 7px 16px;
  border-radius: 20px; border: 1px solid var(--border); background: var(--card);
  color: var(--text); cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.proj-tab:hover { border-color: var(--accent); color: var(--accent); }
.proj-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 700; }

/* Info panel */
.info-panel { padding: 18px; }
.info-panel h2 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.info-pain { color: var(--danger); font-size: 12px; margin: 4px 0; }
.info-insight { color: var(--success); font-size: 12px; margin: 2px 0; }

/* Task groups */
.group-header {
  padding: 12px 18px; display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; user-select: none;
}
.group-header:hover { background: #f1f5f9; }
.group-header.open { background: #f1f5f9; }
.group-title { font-weight: 600; font-size: 13px; }
.group-count { color: var(--text-light); font-weight: 400; }
.group-body { padding: 8px 18px 18px; }

/* Task items */
.task-item {
  border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-top: 8px;
  transition: all 0.2s; position: relative;
}
.task-item.off { background: var(--danger-light); border-color: var(--danger-border); }
.task-row { display: flex; align-items: flex-start; gap: 10px; }
.task-toggle {
  width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--border);
  background: #fff; color: #fff; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;
  transition: all 0.15s; margin-top: 1px;
}
.task-toggle.off { background: var(--danger); border-color: var(--danger); }
.task-toggle:hover { border-color: var(--danger); }
.task-name { font-weight: 600; font-size: 13px; }
.task-name.off { text-decoration: line-through; color: var(--text-light); }
.task-desc { color: var(--text-mid); font-size: 12px; margin-top: 2px; }
.task-risk { color: var(--danger); font-size: 12px; margin-top: 2px; }

/* Task details panel (when OFF) */
.task-details {
  margin: 10px 0 0 34px; background: #fff; border: 1px solid var(--danger-border);
  border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 8px;
}
.task-details .field-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
.task-details label { font-size: 12px; color: var(--text-mid); font-weight: 500; display: flex; align-items: center; gap: 6px; }
.task-details input[type="date"],
.task-details input[type="text"] {
  font-family: var(--font); font-size: 12px; padding: 5px 10px; border-radius: 6px;
  border: 1px solid var(--border); outline: none; transition: border-color 0.2s;
}
.task-details input:focus { border-color: var(--accent); }
.task-details textarea {
  font-family: var(--font); font-size: 12px; padding: 6px 10px; border-radius: 6px;
  border: 1px solid var(--border); outline: none; width: 100%; resize: vertical; min-height: 42px;
  transition: border-color 0.2s; margin-top: 4px;
}
.task-details textarea:focus { border-color: var(--accent); }

/* Selects */
select {
  font-family: var(--font); font-size: 12px; padding: 5px 10px; border-radius: 6px;
  border: 1px solid var(--border); outline: none; background: #fff; cursor: pointer;
}
input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent); }

/* Roadmap */
.phase {
  border-left: 4px solid; padding: 12px 18px; margin-bottom: 12px;
  border-radius: 0 8px 8px 0; background: #f8fafc;
}
.phase-title { font-weight: 700; font-size: 14px; }
.phase-desc { color: var(--text-mid); font-size: 12px; margin-top: 4px; }

/* Audit type badges */
.audit-off { background: var(--danger-light); color: var(--danger); padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; white-space: nowrap; }
.audit-restore { background: var(--success-light); color: var(--success); padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; white-space: nowrap; }
.audit-edit { background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; white-space: nowrap; }

/* Toast */
.toast {
  position: fixed; top: 20px; right: 20px; z-index: 9999;
  background: #065f46; color: #fff; padding: 12px 22px; border-radius: 10px;
  font-size: 13px; font-weight: 500; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Restore button */
.restore-btn {
  font-family: var(--font); font-size: 11px; font-weight: 600; padding: 4px 12px;
  border-radius: 6px; border: none; background: var(--success); color: #fff;
  cursor: pointer; transition: background 0.2s;
}
.restore-btn:hover { background: #047857; }

/* Responsive */
@media (max-width: 768px) {
  .header { padding: 16px 16px 0; }
  .main { padding: 16px; }
  .stats { grid-template-columns: repeat(2, 1fr); }
  .header h1 { font-size: 18px; }
}

/* Hidden sections */
.view-section { display: none; }
.view-section.active { display: block; }

/* Scroll overflow for tables */
.table-wrap { overflow-x: auto; }
</style>
</head>
<body>
<script>
// ============================================================
// DATA
// ============================================================
const INFO = {
  gruh:{label:'Team GRUH',sum:'Handles insider holdings data for US and Canada.',pain:'Without CIK searches require EDGAR lookup then web search.',insight:'Mian has exceptional ability to spot missing data.'},
  '10b51':{label:'10B5-1',sum:'Captures SEC Rule 10b5-1 trading plan disclosures ‚Äî adoption, termination, amendment.',pain:"LLM doesn't assign tags (100% manual). 10% error rate on connections.",insight:'Already 45% AI-assisted. Focus on improving LLM tagging.'},
  f144:{label:'Form 144',sum:'Form 144 filings ‚Äî notices of proposed sale of restricted securities. 150-230 filings/day.',pain:'Parent-Child research and Insider-Issuer validation require deep research.',insight:'As-reported feed automated. Curated feed needs manual research.'},
  fim:{label:'FIM',sum:'Factset Insider Mapping ‚Äî validates 2iQ insider database against Factset.',pain:'Identity resolution is complex ‚Äî same name can be different people.',insight:'Detection automatable. Final decisions need human judgment.'},
  sbb:{label:'SBB',sum:'Share Buyback data from 38 countries. 620 daily filings.',pain:'Factiva: 1,200 headlines daily to find 30-40 intentions.',insight:'10 sources automated. Factiva scanning is prime AI candidate.'},
  marketing:{label:'Marketing',sum:'Content creation for 2iQ and CapitolTrades.',pain:'Finding blog-worthy trades takes most time.',insight:'Trade spotting highly automatable.'},
  ct:{label:'CapitolTrades',sum:'US politician stock trades.',pain:'Website occasionally breaks without alerts.',insight:'Already fully automated.'},
  ssd:{label:'SSD',sum:'European Short Disclosure ‚Äî short selling positions from 18 EU countries.',pain:'Minimal ‚Äî occasional unmapped issuers.',insight:'Fully automated. Haasin is QA bridge.'}
};

const TASKS = {
  gruh:{
    'Butterfly Screens':[
      {id:'bs1',name:'Missing holdings Screen',desc:'Identifies insiders who traded but lack holdings post-trade. Search annual reports, then web.',risk:'Missing holdings not flagged. Data gaps persist.'},
      {id:'bs2',name:'Check_Insider_holdings_USA',desc:'Validates US insider holdings completeness against SEC filings.',risk:'US holdings gaps undetected.'},
      {id:'bs3',name:'Check_Insider_holdings_CANADA',desc:'Validates Canadian insider holdings against SEDI filings.',risk:'Canadian holdings gaps undetected.'},
      {id:'bs4',name:'US_INSIDER_H_BLACKLIST_TO_BE_CLONED',desc:'US insider records on blacklist needing cloning.',risk:'Blacklisted insiders not tracked.'},
      {id:'bs5',name:'US_INSIDER_H_BLACKLIST_MANUAL_CALCULATION',desc:'Manual calculation for blacklisted US insider holdings.',risk:'Blacklist calculations incorrect.'},
      {id:'bs6',name:'CAN_INSIDER_H_BLACKLIST_MANUAL_CALCULA',desc:'Manual calculation for Canadian blacklisted holdings.',risk:'Canadian blacklist errors.'},
      {id:'bs7',name:'Form 144 Related Screens',desc:'Screens for Form 144 filings linkage.',risk:'Form 144 linkage issues.'},
      {id:'bs8',name:'Inactive Screen',desc:'Identifies inactive insider records needing cleanup.',risk:'Inactive records clutter DB.'},
      {id:'bs9',name:'Without CIK',desc:'Records missing CIK. Check EDGAR first, then web search.',risk:'Records unmapped to SEC.'}
    ],
    'I-tracking':[
      {id:'it1',name:'Insider Holdings inbox US/Canada',desc:'Processes incoming holdings filings from SEC and SEDI.',risk:'New filings not processed.'},
      {id:'it2',name:'Form 144',desc:'Processes Form 144 notices of proposed sale.',risk:'Intent to sell not captured.'},
      {id:'it3',name:'Matching Companies - Inbox',desc:'Matches incoming companies to database.',risk:'Duplicate companies created.'},
      {id:'it4',name:'I-Tracking Screening tool',desc:'Filters and prioritizes items for analysts.',risk:'Analyst efficiency drops.'}
    ],
    'Reports':[
      {id:'rp1',name:'SCR_MATCHINGEVENTCHECK',desc:'Checks for matching/duplicate events.',risk:'Duplicates slip through.'},
      {id:'rp2',name:'missing companies report',desc:'Companies in filings but not in database.',risk:'Coverage gaps.'},
      {id:'rp3',name:'USAInsiderHoldingsCloner',desc:'Clones USA holdings for multi-relationship insiders.',risk:'Incorrect attribution.'},
      {id:'rp4',name:'Screen for Missing Trade',desc:'Identifies trades missing from database.',risk:'Significant data gaps.'},
      {id:'rp5',name:'Source Type Statistics Reports',desc:'Statistics on data sources.',risk:'Quality issues undetected.'},
      {id:'rp6',name:'InsiderHoldingsUSClonerErrorFilings',desc:'Errors from US Holdings Cloner.',risk:'Cloner errors accumulate.'},
      {id:'rp7',name:'Delegation report',desc:'Tracks delegation of insider authority.',risk:'Delegation tracking lost.'},
      {id:'rp8',name:'NEWLY ADDED COMPANIES FROM COMPUSTAT',desc:'New companies from Compustat feed.',risk:'New companies not onboarded.'},
      {id:'rp9',name:'CompaniesNotMatched',desc:'Companies that could not be matched.',risk:'Unmatched queue grows.'},
      {id:'rp10',name:'SCR_TRANSACTIONSINDELETEDCOMPANIES',desc:'Transactions in deleted companies.',risk:'Orphaned transactions.'}
    ],
    'Channels':[
      {id:'ch1',name:'RSS Feed',desc:'Monitors RSS feeds for new filings.',risk:'No feed monitoring.'},
      {id:'ch2',name:'Check Filling',desc:'Validates filing completeness.',risk:'Incomplete filings enter DB.'},
      {id:'ch3',name:'Holding Update',desc:'Processes updates to holdings.',risk:'Holdings become stale.'},
      {id:'ch4',name:'WEEKLY DIGEST',desc:'Weekly summary of activity.',risk:'No weekly monitoring.'},
      {id:'ch5',name:'Bot-Issue',desc:'Flags bot processing issues.',risk:'Bot failures unnoticed.'},
      {id:'ch6',name:'Bots-New-sources',desc:'New source integration.',risk:'New sources stall.'}
    ],
    'Side Tasks':[
      {id:'st1',name:'Holdings Follow ups',desc:'Complete trades by inputting holdings from notes.',risk:'Incomplete records persist.'},
      {id:'st2',name:'New Source Research',desc:'Research new data sources.',risk:'Coverage stagnates.'},
      {id:'st3',name:'Compustat Emails Reply',desc:'Respond to Compustat queries.',risk:'Vendor relationship issues.'},
      {id:'st4',name:'Checking of all Task',desc:'QA check across all tasks.',risk:'Errors slip through.'}
    ],
    'Filings Manual Creation':[
      {id:'fm1',name:'Egypt',desc:'Manual filings for Egyptian market.',risk:'Egypt coverage lost.'},
      {id:'fm2',name:'Spain',desc:'Manual filings for Spanish market.',risk:'Spain coverage reduced.'},
      {id:'fm3',name:'Estonia',desc:'Manual filings for Estonian market.',risk:'Estonia coverage lost.'},
      {id:'fm4',name:'Czech Republic',desc:'Manual filings for Czech market.',risk:'Czech coverage lost.'},
      {id:'fm5',name:'Bulgaria',desc:'Manual filings for Bulgarian market.',risk:'Bulgaria coverage lost.'},
      {id:'fm6',name:'Malta',desc:'Manual filings for Maltese market.',risk:'Malta coverage lost.'},
      {id:'fm7',name:'NSX',desc:'Manual filings for NSX exchange.',risk:'NSX coverage lost.'}
    ],
    'HoneyComb':[
      {id:'hc1',name:'Form 144 Mapping',desc:'Maps Form 144 to internal structure.',risk:'Mapping breaks.'},
      {id:'hc2',name:'Filings remapping',desc:'Remaps when records change.',risk:'Orphaned filings.'},
      {id:'hc3',name:'IsLegal Property',desc:'Legal property flags.',risk:'Compliance risk.'},
      {id:'hc4',name:'Properties editors',desc:'Edit various properties.',risk:'Editing blocked.'},
      {id:'hc5',name:'Suspicious',desc:'Flags suspicious transactions.',risk:'Fraud detection lost.'}
    ]
  },
  '10b51':{
    'Mappings':[
      {id:'mp1',name:'Issuer Mapping',desc:'Maps issuers via CIK, checks duplicates.',risk:'New issuers not tracked.'},
      {id:'mp2',name:'Insider Mapping',desc:'Maps insiders, creates parent-child relationships.',risk:'Family links lost.'},
      {id:'mp3',name:'Security Mapping',desc:'Maps securities from announcements.',risk:'Wrong securities.'},
      {id:'mp4',name:'Insider Relationship',desc:'Manages parent-child connections.',risk:'Relationships lost.'}
    ],
    'Quality Gates':[
      {id:'qg1',name:'Missing Shares Info',desc:'No shares reported. Select Number/Aggregate/Notional.',risk:'Share data gaps.'},
      {id:'qg2',name:'Transaction Tag',desc:'Apply tags for RSU/PSU/options.',risk:'Untagged transactions.'},
      {id:'qg3',name:'Transaction type Other',desc:'Reclassify Other transactions.',risk:'Others unresolved.'},
      {id:'qg4',name:'Transaction type Buy',desc:'Verify rare buy transactions.',risk:'Buys not verified.'},
      {id:'qg5',name:'Missing Security Breakdown',desc:'Check if breakdown needed.',risk:'Breakdowns missed.'},
      {id:'qg6',name:'Duplicate Filings',desc:'Same accession number.',risk:'Duplicates enter DB.'},
      {id:'qg7',name:'Date Validations',desc:'5 date logic checks.',risk:'Date errors persist.'},
      {id:'qg8',name:'Null fields',desc:'Null transaction/security types.',risk:'Null values persist.'},
      {id:'qg9',name:'Plan Linkage',desc:'Link termination to adoption.',risk:'History lost.'}
    ],
    'Exception Handling':[
      {id:'ex1',name:'No Section Detected',desc:'Manual review for pattern changes.',risk:'Missed filings.'},
      {id:'ex2',name:'Manual Processing',desc:'Full manual extraction.',risk:'Complex filings skipped.'}
    ]
  },
  f144:{
    'Form 144 Tasks':[
      {id:'f1',name:'New Issuer/Affiliate/Broker Mapping',desc:'Map new entities or name changes introduced into database.',risk:'New entities unmapped.'},
      {id:'f2',name:'Security Mapping',desc:'Cross-check with company financials, assign correct title.',risk:'Securities incorrectly mapped.'},
      {id:'f3',name:'Parent-Child Relationship Analysis',desc:'Deep research to determine if one affiliate is parent of another.',risk:'Parent-child relationships missed.'},
      {id:'f4',name:'Insider-Issuer Relationship Validation',desc:'Research and verify if relationship needs updates based on filings.',risk:'Stale relationships persist.'},
      {id:'f5',name:'Quality Gate Review',desc:'Assign quality flags by analyzing filing remarks.',risk:'Quality flags not assigned.'}
    ]
  },
  fim:{
    'Butterfly Reports':[
      {id:'fr1',name:'MissingInsiderProperty (5 regions)',desc:'Missing properties for Canada/SEC/Israel/HK/KRX.',risk:'Property gaps undetected.'},
      {id:'fr2',name:'MultipleValues (5 regions)',desc:'Conflicting values across regions.',risk:'Conflicts unresolved.'},
      {id:'fr3',name:'MergeInsiders (5 regions)',desc:'Potential merges by property.',risk:'Merges missed.'},
      {id:'fr4',name:'SecMergeInsiderByCik',desc:'SEC merge by CIK.',risk:'CIK merges missed.'},
      {id:'fr5',name:'FactsetPotentiallyWrongMappedCompany',desc:'Wrong company mappings.',risk:'Wrong mappings persist.'},
      {id:'fr6',name:'InsidersWithMissingIsLegalDefinition',desc:'Missing legal definition.',risk:'Legal status unknown.'}
    ],
    'Butterfly Screens':[
      {id:'fs1',name:'Check_Insider_merge_and_Name',desc:'Merge checks by name matching.',risk:'Name merges missed.'},
      {id:'fs2',name:'CheckMerge',desc:'General merge check.',risk:'Candidates not surfaced.'},
      {id:'fs3',name:'Missing_FIM_Mapping',desc:'Missing Factset mapping.',risk:'Unmapped insiders.'}
    ],
    'Insider Quality Gates':[
      {id:'iq1',name:'2IQ Factset name Different',desc:'Name discrepancies.',risk:'Names unresolved.'},
      {id:'iq2',name:'Factset Insider missing context',desc:'Missing company link.',risk:'Context broken.'},
      {id:'iq3',name:'Possible demerge',desc:'One record may be two people.',risk:'Wrong merges persist.'},
      {id:'iq4',name:'Possible merge',desc:'Two records may be one person.',risk:'Duplicates persist.'}
    ],
    'Mapping Work':[
      {id:'mw1',name:'Company Level Mapping',desc:'Map companies between databases.',risk:'Company mappings incomplete.'},
      {id:'mw2',name:'Insider Level Mapping',desc:'Deep research ‚Äî bios, photos, age.',risk:'Insider mappings incomplete.'}
    ]
  },
  sbb:{
    'Automated Pipeline':[
      {id:'ap1',name:'URL Collection Bot',desc:'Crawls source pages.',risk:'Pipeline stops.'},
      {id:'ap2',name:'Item 2 Extraction',desc:'Extracts Item 2 from URLs.',risk:'No extraction.'},
      {id:'ap3',name:'LLM Relevance Check',desc:'Checks buyback relevance.',risk:'Irrelevant content passes.'},
      {id:'ap4',name:'LLM Data Extraction',desc:'Extracts structured data.',risk:'No automated extraction.'},
      {id:'ap5',name:'Company Mapping (CIK)',desc:'Auto-map by CIK.',risk:'Mapping fails.'}
    ],
    'Manual Processing':[
      {id:'smp1',name:'Analyst Validation',desc:'Review extracted data.',risk:'Quality drops.'},
      {id:'smp2',name:'Manual Company Mapping',desc:'Map when auto fails.',risk:'Unmapped accumulate.'},
      {id:'smp3',name:'Manual Item 2 Search',desc:'Search when bot fails.',risk:'Missed filings.'},
      {id:'smp4',name:'Manual Data Extraction',desc:'Full manual extraction.',risk:'Complex filings skipped.'}
    ],
    'Factiva Processing':[
      {id:'fv1',name:'Headline Scanning',desc:'1,200 headlines daily for 30-40 intentions.',risk:'Intentions not captured.'},
      {id:'fv2',name:'Intention Detail Extraction',desc:'Extract amount, timeline, reason.',risk:'Details incomplete.'}
    ],
    'Country Sources':[
      {id:'cs1',name:'USA (SEC)',desc:'97,792 trades via EDGAR.',risk:'US coverage lost.'},
      {id:'cs2',name:'UK (LSE)',desc:'171,887 trades.',risk:'UK coverage lost.'},
      {id:'cs3',name:'Japan',desc:'246,090 trades via EDINET/TDNet.',risk:'Japan coverage lost.'},
      {id:'cs4',name:'Other 35 Countries',desc:'Various exchanges.',risk:'Multi-market reduced.'}
    ]
  },
  marketing:{
    'Content Creation':[
      {id:'cc1',name:'2iQ Monthly Newsletter',desc:'Monthly with metrics and insights.',risk:'Engagement drops.'},
      {id:'cc2',name:'CT Weekly Newsletter',desc:'Weekly politician trading.',risk:'CT engagement drops.'},
      {id:'cc3',name:'Blog Writing',desc:'Daily search for blog-worthy trades.',risk:'No blog content.'},
      {id:'cc4',name:'Buzz Content',desc:'Short-form for CT website.',risk:'CT content stales.'},
      {id:'cc5',name:'Politician of Week',desc:'Weekly notable politician.',risk:'Signature content lost.'}
    ],
    'Social Media':[
      {id:'sm1',name:'2iQ X Handle',desc:'Company Twitter/X.',risk:'Social presence drops.'},
      {id:'sm2',name:'CT X Handle',desc:'CapitolTrades Twitter/X.',risk:'CT engagement lost.'}
    ],
    'Design & Internal':[
      {id:'di1',name:'Canva Design',desc:'Visual design work.',risk:'Quality drops.'},
      {id:'di2',name:'Internal Communications',desc:'Birthdays, LinkedIn.',risk:'Culture activities stop.'}
    ]
  },
  ct:{
    'Automated Systems':[
      {id:'as1',name:'Data Pipeline',desc:'Scrapes Senate/House disclosures.',risk:'CT data stops.'},
      {id:'as2',name:'Website Auto-Update',desc:'Auto-publishes trades.',risk:'Stale data shown.'}
    ],
    'Manual Oversight':[
      {id:'mo1',name:'Data Monitoring',desc:'Huzaifa checks 15 min/day.',risk:'Issues undetected.'},
      {id:'mo2',name:'Data Requests',desc:'Provides data to Turra.',risk:'Content team lacks data.'}
    ]
  },
  ssd:{
    'Automated Systems':[
      {id:'ss1',name:'Data Ingestion',desc:'Ingests from 18 EU sources.',risk:'EU data stops.'},
      {id:'ss2',name:'Quality Gates',desc:'Auto quality checks.',risk:'Quality issues.'}
    ],
    'Manual Oversight':[
      {id:'so1',name:'Stuck Record Resolution',desc:'Clear unmapped records.',risk:'Records accumulate.'},
      {id:'so2',name:'Regulator Contact',desc:'Contact when issues arise.',risk:'Issues unresolved.'},
      {id:'so3',name:'QA Bridge',desc:'Coordinate analysts and IT.',risk:'Slow resolution.'}
    ]
  }
};

const INIT_PROJECTS = [
  {id:'gruh',hc:6,fut:2,opp:'High',pri:1,status:'Partial',
    members:[
      {name:'Mian Jahanziab Ahmad',role:'Senior Team Lead',key:true,rec:'Retain - AI Oversight'},
      {name:'Javeria Tahir',role:'Supervisor',key:true,rec:''},
      {name:'Isma Ishfaq',role:'Level 2 Analyst',key:true,rec:''},
      {name:'Muzzamil Noor Butt',role:'Level 1 Analyst',key:true,rec:''},
      {name:'Areej Shahid',role:'Trainee',key:false,rec:''},
      {name:'Hassan Rasheed',role:'Trainee',key:false,rec:''}
    ],
    groups:['Butterfly Screens','I-tracking','Reports','Channels','Side Tasks','Filings Manual Creation','HoneyComb']},
  {id:'10b51',hc:3,fut:2,opp:'Medium',pri:3,status:'LLM Exists (90%)',
    members:[
      {name:'Hannan Saleem',role:'Senior Analyst',key:false,rec:''},
      {name:'Mansub Niaz',role:'Senior Analyst',key:false,rec:''},
      {name:'Muhammad Asad',role:'Trainee',key:false,rec:''}
    ],
    groups:['Mappings','Quality Gates','Exception Handling']},
  {id:'f144',hc:3,fut:2,opp:'Medium',pri:3,status:'Partial (as-reported auto)',
    members:[
      {name:'Muhammad Awais Nayyer',role:'Project Head',key:true,rec:'Retain - Oversight'},
      {name:'Yousaf Saeed',role:'Lead Analyst',key:false,rec:''},
      {name:'Waqas Raza Butt',role:'Supervisor',key:false,rec:''}
    ],
    groups:['Form 144 Tasks']},
  {id:'fim',hc:5,fut:2,opp:'Medium-High',pri:2,status:'Manual',
    members:[
      {name:'Humayon Rafique',role:'Associate Unit Head',key:true,rec:'Retain'},
      {name:'Kashif Ali',role:'Level 3 Analyst',key:false,rec:''},
      {name:'Shahid Raza',role:'Level 3 Analyst',key:false,rec:''},
      {name:'Ali Faran',role:'Level 3 Analyst',key:false,rec:''},
      {name:'Nadeem Zahoor',role:'Level 3 Analyst',key:false,rec:''}
    ],
    groups:['Butterfly Reports','Butterfly Screens','Insider Quality Gates','Mapping Work']},
  {id:'sbb',hc:6,fut:2,opp:'High',pri:1,status:'10 Sources Automated',
    members:[
      {name:'Muhammad Taimoor Waheed',role:'Project Head',key:true,rec:'Retain'},
      {name:'Muhammad Noor Ud Deen',role:'Lead Mentor',key:false,rec:''},
      {name:'Ali Raza Shah',role:'QA Analyst',key:false,rec:''},
      {name:'Farhan Qamar',role:'Level 2',key:false,rec:''},
      {name:'Umer Iftikhar',role:'Trainee',key:false,rec:''},
      {name:'Fahad Sohail',role:'Trainee',key:false,rec:''}
    ],
    groups:['Automated Pipeline','Manual Processing','Factiva Processing','Country Sources']},
  {id:'marketing',hc:2,fut:1,opp:'High',pri:2,status:'Manual',
    members:[
      {name:'Turra Rasheed',role:'Manager',key:true,rec:'Retain'},
      {name:'Nimra Pervez',role:'Senior Officer',key:false,rec:''}
    ],
    groups:['Content Creation','Social Media','Design & Internal']},
  {id:'ct',hc:0,fut:0,opp:'Done',pri:5,status:'Fully Automated',
    members:[{name:'Huzaifa (shared)',role:'15 min/day',key:false,rec:''}],
    groups:['Automated Systems','Manual Oversight']},
  {id:'ssd',hc:1,fut:1,opp:'Done',pri:5,status:'Fully Automated',
    members:[{name:'Muhammad Haasin Saleem',role:'Project Head',key:true,rec:'Retain'}],
    groups:['Automated Systems','Manual Oversight']}
];

// Baked-in GRUH changes from screenshots
const INIT_TS = {
  bs2:{off:true,date:'2026-02-09',by:'Robert',notes:'Decisions made by Robert'},
  bs4:{off:true,date:'2026-02-09',by:'Robert',notes:'Decisions made by Robert'},
  bs5:{off:true,date:'2026-02-09',by:'Robert',notes:'Decisions made by Robert'},
  bs8:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'Transferred to Jawad Khan Team'},
  bs9:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'Transferred to Jawad Khan Team'},
  it1:{off:true,date:'2026-02-09',by:'Robert',notes:'Insider US will go but Canada will remain in i-Tracking'},
  rp1:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'Double check the Matched company'},
  rp3:{off:true,date:'2026-02-09',by:'Robert',notes:'Decisions made by Robert'},
  rp5:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'It is a duplicate of check fillings which we have decided to continue'},
  rp6:{off:true,date:'2026-02-09',by:'Robert',notes:'Close Robert made the decision'},
  rp7:{off:true,date:'2026-02-28',by:'Zabih Ullah',notes:'Decisions made based on discussions with Team Lead Jawad and shared with Robert & Dimitar.'},
  rp10:{off:true,date:'2026-02-09',by:'Zabih Ullah and Jawad',notes:'Another security check can perform a similar check so this will be shut down.'},
  ch1:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'Decisions made based on discussions with Team Lead Jawad and shared with Robert & Dimitar.'},
  ch4:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'It shows the companies not matched over the last 7, 25 etc days but almost 99.9% are duplicate'},
  ch6:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'We will not add new sources until a shift to AI. The ones added have history going back to 2015 like KSA, Jordan, Qatar, Bahrain.'},
  st1:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'Transferred to Jawad Khan Team'},
  st2:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'No new sources until AI shift'},
  st4:{off:true,date:'2026-02-09',by:'Zabih Ullah',notes:'Cleaning up checking everything is done internal report of tasks'}
};

const RECS = ['','Retain','Upskill','Redeploy','At Risk'];

// ============================================================
// STATE
// ============================================================
let state = {
  projects: JSON.parse(JSON.stringify(INIT_PROJECTS)),
  ts: JSON.parse(JSON.stringify(INIT_TS)),
  log: [],
  view: 'overview',
  sel: 'gruh',
  expanded: {}
};

// Build initial log from baked-in changes
function buildInitLog() {
  const allItems = getAllItems();
  const entries = [];
  for (const [id, s] of Object.entries(INIT_TS)) {
    const item = allItems.find(t => t.id === id);
    entries.push({
      ts: s.date + 'T00:00:00Z', type: 'TASK_OFF', project: 'gruh',
      taskId: id, taskName: item ? item.name : id, field: 'status',
      oldVal: 'Active', newVal: 'OFF', by: s.by, notes: s.notes
    });
  }
  return entries;
}

function getAllItems() {
  const items = [];
  for (const groups of Object.values(TASKS)) {
    for (const arr of Object.values(groups)) {
      items.push(...arr);
    }
  }
  return items;
}

function findProject(taskId) {
  for (const [pid, groups] of Object.entries(TASKS)) {
    for (const items of Object.values(groups)) {
      if (items.find(t => t.id === taskId)) return pid;
    }
  }
  return '';
}

// ============================================================
// PERSISTENCE (localStorage)
// ============================================================
function saveState() {
  try {
    localStorage.setItem('2iq-dash-v6', JSON.stringify({
      projects: state.projects, ts: state.ts, log: state.log
    }));
  } catch(e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem('2iq-dash-v6');
    if (raw) {
      const d = JSON.parse(raw);
      if (d.projects) state.projects = d.projects;
      if (d.ts) state.ts = d.ts;
      if (d.log) state.log = d.log;
    } else {
      state.log = buildInitLog();
    }
  } catch(e) {
    state.log = buildInitLog();
  }
}

// ============================================================
// ACTIONS
// ============================================================
function addLog(entry) {
  state.log.unshift({ ...entry, ts: new Date().toISOString() });
  saveState();
}

function toggleTask(id) {
  const allItems = getAllItems();
  const item = allItems.find(t => t.id === id);
  const proj = findProject(id);
  if (state.ts[id]?.off) {
    delete state.ts[id];
    addLog({ type:'TASK_RESTORED', project:proj, taskId:id, taskName:item?.name||id, field:'status', oldVal:'OFF', newVal:'Active', by:'User', notes:'Restored' });
  } else {
    state.ts[id] = { off:true, date:new Date().toISOString().split('T')[0], by:'', notes:'' };
    addLog({ type:'TASK_OFF', project:proj, taskId:id, taskName:item?.name||id, field:'status', oldVal:'Active', newVal:'OFF', by:'', notes:'' });
  }
  saveState();
  render();
}

function updateTaskField(id, field, val) {
  const old = state.ts[id]?.[field] || '';
  if (!state.ts[id]) state.ts[id] = {};
  state.ts[id][field] = val;
  const allItems = getAllItems();
  const item = allItems.find(t => t.id === id);
  addLog({ type:'TASK_EDIT', project:findProject(id), taskId:id, taskName:item?.name||id, field, oldVal:old, newVal:val, by:'User', notes:'' });
  saveState();
}

function updateMember(projId, idx, field, val) {
  const proj = state.projects.find(p => p.id === projId);
  const old = proj.members[idx][field];
  proj.members[idx][field] = val;
  addLog({ type:'PERSONNEL_EDIT', project:projId, taskId:'', taskName:proj.members[idx].name, field, oldVal:String(old), newVal:String(val), by:'User', notes:'' });
  saveState();
  render();
}

function toggleExpand(key) {
  state.expanded[key] = !state.expanded[key];
  render();
}

function setView(v) { state.view = v; render(); }
function setSel(id) { state.sel = id; render(); }

// ============================================================
// EXCEL EXPORT
// ============================================================
function exportExcel() {
  const allItems = getAllItems();
  // Sheet 1: Audit Log
  const logRows = state.log.map((e, i) => ({
    '#': state.log.length - i,
    'Timestamp': e.ts ? new Date(e.ts).toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '',
    'Type': e.type,
    'Project': INFO[e.project]?.label || e.project,
    'Task/Person': e.taskName,
    'Field': e.field,
    'Old Value': e.oldVal,
    'New Value': e.newVal,
    'Changed By': e.by,
    'Notes': e.notes
  }));
  const ws1 = XLSX.utils.json_to_sheet(logRows);
  ws1['!cols'] = [{wch:5},{wch:22},{wch:16},{wch:14},{wch:38},{wch:10},{wch:16},{wch:16},{wch:20},{wch:50}];

  // Sheet 2: Task Status
  const statusRows = [];
  for (const [pid, groups] of Object.entries(TASKS)) {
    for (const [gname, items] of Object.entries(groups)) {
      for (const item of items) {
        const st = state.ts[item.id];
        statusRows.push({
          'Project': INFO[pid]?.label || pid,
          'Group': gname,
          'Task': item.name,
          'Status': st?.off ? 'OFF' : 'Active',
          'Date Off': st?.date || '',
          'Approved By': st?.by || '',
          'Notes': st?.notes || '',
          'Risk If Stopped': item.risk
        });
      }
    }
  }
  const ws2 = XLSX.utils.json_to_sheet(statusRows);
  ws2['!cols'] = [{wch:14},{wch:22},{wch:38},{wch:8},{wch:12},{wch:20},{wch:50},{wch:40}];

  // Sheet 3: Personnel
  const persRows = [];
  for (const pr of state.projects) {
    for (const m of pr.members) {
      persRows.push({
        'Project': INFO[pr.id]?.label || pr.id,
        'Name': m.name,
        'Role': m.role,
        'Key Person': m.key ? 'Yes' : 'No',
        'Recommendation': m.rec || ''
      });
    }
  }
  const ws3 = XLSX.utils.json_to_sheet(persRows);
  ws3['!cols'] = [{wch:14},{wch:30},{wch:22},{wch:12},{wch:20}];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, 'Audit Log');
  XLSX.utils.book_append_sheet(wb, ws2, 'Task Status');
  XLSX.utils.book_append_sheet(wb, ws3, 'Personnel');
  XLSX.writeFile(wb, '2iQ_Transition_Audit_' + new Date().toISOString().split('T')[0] + '.xlsx');
  showToast('Excel exported successfully!');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => { t.style.display = 'none'; }, 2500);
}
</script>
<script>
// ============================================================
// RENDER ENGINE
// ============================================================
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function oppBadge(opp) {
  const cls = opp === 'High' ? 'badge-high' : opp === 'Done' ? 'badge-done' : 'badge-medium';
  return `<span class="badge ${cls}">${esc(opp)}</span>`;
}
function priBadge(pri) {
  const cls = pri === 1 ? 'badge-p1' : pri === 2 ? 'badge-p2' : 'badge-p3';
  return `<span class="badge ${cls}">P${pri}</span>`;
}

function render() {
  const totalCur = state.projects.reduce((s, p) => s + p.hc, 0);
  const totalFut = state.projects.reduce((s, p) => s + p.fut, 0);
  const totalOff = Object.values(state.ts).filter(v => v.off).length;
  const totalTasks = getAllItems().length;

  // Subtitle
  document.getElementById('subtitle').textContent = `${totalCur} staff ‚Üí ${totalFut} target ¬∑ ${totalOff} of ${totalTasks} functions turned off`;

  // Tabs
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.view === state.view);
  });

  // Views
  document.querySelectorAll('.view-section').forEach(v => {
    v.classList.toggle('active', v.id === 'v-' + state.view);
  });

  // Render active view
  if (state.view === 'overview') renderOverview(totalCur, totalFut, totalOff);
  else if (state.view === 'projects') renderProjects();
  else if (state.view === 'personnel') renderPersonnel();
  else if (state.view === 'audit') renderAudit();
  else if (state.view === 'roadmap') renderRoadmap();
}

function renderOverview(totalCur, totalFut, totalOff) {
  const el = document.getElementById('v-overview');
  el.innerHTML = `
    <div class="stats">
      <div class="stat-card"><div class="stat-value" style="color:var(--accent)">${totalCur}</div><div class="stat-label">Current Staff</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--success)">${totalFut}</div><div class="stat-label">Future Target</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--danger)">-${totalCur - totalFut}</div><div class="stat-label">Reduction</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--warn)">${totalOff}</div><div class="stat-label">Functions Off</div></div>
    </div>
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Project</th><th style="text-align:center">Staff</th><th style="text-align:center">Future</th>
            <th style="text-align:center">Œî</th><th>Status</th><th style="text-align:center">AI Opportunity</th><th style="text-align:center">Priority</th>
          </tr></thead>
          <tbody>
            ${state.projects.map(p => {
              const delta = p.hc - p.fut;
              return `<tr class="clickable" onclick="setSel('${p.id}');setView('projects')">
                <td style="font-weight:600">${esc(INFO[p.id]?.label || p.id)}</td>
                <td style="text-align:center">${p.hc}</td>
                <td style="text-align:center;color:var(--success);font-weight:600">${p.fut}</td>
                <td style="text-align:center;color:var(--danger);font-weight:500">${delta > 0 ? '-' + delta : '‚Äî'}</td>
                <td style="font-size:12px;color:var(--text-mid)">${esc(p.status)}</td>
                <td style="text-align:center">${oppBadge(p.opp)}</td>
                <td style="text-align:center">${priBadge(p.pri)}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderProjects() {
  const el = document.getElementById('v-projects');
  const proj = state.projects.find(p => p.id === state.sel);
  if (!proj) return;
  const info = INFO[proj.id];
  const projTasks = TASKS[proj.id] || {};

  let html = `<div class="proj-tabs">`;
  state.projects.forEach(p => {
    html += `<button class="proj-tab ${state.sel === p.id ? 'active' : ''}" onclick="setSel('${p.id}')">${esc(INFO[p.id]?.label || p.id)}</button>`;
  });
  html += `</div>`;

  // Info card
  html += `<div class="card" style="margin-bottom:16px">
    <div class="info-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2>${esc(info?.label || '')}</h2>
        ${oppBadge(proj.opp)}
      </div>
      <p style="color:var(--text-mid);margin:4px 0">${esc(info?.sum || '')}</p>
      <p class="info-pain">‚ö†Ô∏è <strong>Pain:</strong> ${esc(info?.pain || '')}</p>
      <p class="info-insight">üí° <strong>Insight:</strong> ${esc(info?.insight || '')}</p>
    </div>
  </div>`;

  // Task groups
  html += `<div class="card" style="margin-bottom:16px">
    <div class="card-header"><h3>Tasks & Sub-Tasks</h3></div>`;
  
  proj.groups.forEach(gname => {
    const items = projTasks[gname] || [];
    const offCount = items.filter(i => state.ts[i.id]?.off).length;
    const key = state.sel + '|' + gname;
    const isOpen = state.expanded[key];

    html += `<div>
      <div class="group-header ${isOpen ? 'open' : ''}" onclick="toggleExpand('${key}')">
        <span><span class="group-title">${esc(gname)}</span> <span class="group-count">(${items.length})</span></span>
        <span style="display:flex;align-items:center;gap:8px">
          ${offCount > 0 ? `<span class="badge badge-off">${offCount} OFF</span>` : ''}
          <span style="color:var(--text-light);font-size:11px">${isOpen ? '‚ñº' : '‚ñ∂'}</span>
        </span>
      </div>`;

    if (isOpen) {
      html += `<div class="group-body">`;
      items.forEach(item => {
        const st = state.ts[item.id];
        const isOff = st?.off;
        html += `<div class="task-item ${isOff ? 'off' : ''}">
          <div class="task-row">
            <button class="task-toggle ${isOff ? 'off' : ''}" onclick="toggleTask('${item.id}')">${isOff ? '‚úï' : ''}</button>
            <div style="flex:1;min-width:0">
              <div class="task-name ${isOff ? 'off' : ''}">${esc(item.name)}</div>
              <div class="task-desc">${esc(item.desc)}</div>
              <div class="task-risk">‚ö† <strong>If stopped:</strong> ${esc(item.risk)}</div>
            </div>
          </div>`;

        if (isOff) {
          html += `<div class="task-details">
            <div class="field-row">
              <label>Date: <input type="date" value="${esc(st?.date || '')}" onchange="updateTaskField('${item.id}','date',this.value)"></label>
              <label style="flex:1;min-width:150px">Approved by: <input type="text" value="${esc(st?.by || '')}" onchange="updateTaskField('${item.id}','by',this.value)" placeholder="Name" style="flex:1;width:100%"></label>
            </div>
            <label>Notes:<textarea onchange="updateTaskField('${item.id}','notes',this.value)" placeholder="Reason and expected impact">${esc(st?.notes || '')}</textarea></label>
          </div>`;
        }
        html += `</div>`;
      });
      html += `</div>`;
    }
    html += `</div>`;
  });
  html += `</div>`;

  // Team table
  html += `<div class="card">
    <div class="card-header"><h3>Team (${proj.members.length})</h3></div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Role</th><th style="text-align:center">Key Person</th><th>Action</th></tr></thead>
        <tbody>`;
  proj.members.forEach((m, i) => {
    html += `<tr class="${m.key ? 'key-row' : ''}">
      <td style="font-weight:500">${esc(m.name)}</td>
      <td style="color:var(--text-mid)">${esc(m.role)}</td>
      <td style="text-align:center"><input type="checkbox" ${m.key ? 'checked' : ''} onchange="updateMember('${proj.id}',${i},'key',this.checked)"></td>
      <td><select value="${esc(m.rec)}" onchange="updateMember('${proj.id}',${i},'rec',this.value)">
        ${RECS.map(r => `<option value="${esc(r)}" ${m.rec === r ? 'selected' : ''}>${r || 'Select...'}</option>`).join('')}
      </select></td>
    </tr>`;
  });
  html += `</tbody></table></div></div>`;

  el.innerHTML = html;
}

function renderPersonnel() {
  const el = document.getElementById('v-personnel');
  let html = `<div class="card">
    <div class="card-header"><h3>All Personnel (${state.projects.reduce((s, p) => s + p.members.length, 0)} members)</h3></div>
    <div class="table-wrap"><table>
      <thead><tr><th>Name</th><th>Project</th><th>Role</th><th style="text-align:center">Key</th><th>Recommendation</th></tr></thead>
      <tbody>`;
  state.projects.forEach(p => {
    p.members.forEach((m, i) => {
      html += `<tr class="${m.key ? 'key-row' : ''}">
        <td style="font-weight:500">${esc(m.name)}</td>
        <td><span class="badge badge-done">${esc(INFO[p.id]?.label || p.id)}</span></td>
        <td style="color:var(--text-mid)">${esc(m.role)}</td>
        <td style="text-align:center"><input type="checkbox" ${m.key ? 'checked' : ''} onchange="updateMember('${p.id}',${i},'key',this.checked)"></td>
        <td><select onchange="updateMember('${p.id}',${i},'rec',this.value)">
          ${RECS.map(r => `<option value="${esc(r)}" ${m.rec === r ? 'selected' : ''}>${r || 'Select...'}</option>`).join('')}
        </select></td>
      </tr>`;
    });
  });
  html += `</tbody></table></div></div>`;
  el.innerHTML = html;
}

function renderAudit() {
  const el = document.getElementById('v-audit');
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <div>
      <h2 style="font-size:18px;font-weight:700;margin:0">Audit Log</h2>
      <p style="margin:2px 0 0;color:var(--text-light);font-size:12px">${state.log.length} entries ¬∑ Every change is recorded for accountability</p>
    </div>
    <button class="export-btn" onclick="exportExcel()" style="background:var(--accent-light);color:var(--accent);border-color:var(--accent)">üìä Export to Excel</button>
  </div>
  <div class="card"><div class="table-wrap"><table>
    <thead style="background:#f8fafc"><tr>
      <th>#</th><th>Timestamp</th><th>Type</th><th>Project</th><th>Task / Person</th>
      <th>Field</th><th>Old</th><th>New</th><th>By</th><th>Notes</th>
    </tr></thead><tbody>`;

  if (state.log.length === 0) {
    html += `<tr><td colspan="10" style="padding:40px;text-align:center;color:var(--text-light)">No changes recorded yet.</td></tr>`;
  } else {
    state.log.slice(0, 200).forEach((e, i) => {
      const cls = e.type.includes('OFF') ? 'audit-off' : e.type.includes('RESTORE') ? 'audit-restore' : 'audit-edit';
      html += `<tr>
        <td style="color:var(--text-light);font-size:11px">${state.log.length - i}</td>
        <td style="font-size:11px;white-space:nowrap;color:var(--text-mid)">${e.ts ? new Date(e.ts).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '‚Äî'}</td>
        <td><span class="${cls}">${esc(e.type.replace(/_/g,' '))}</span></td>
        <td style="font-size:12px">${esc(INFO[e.project]?.label || e.project)}</td>
        <td style="font-size:12px;font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(e.taskName)}</td>
        <td style="font-size:11px;color:var(--text-mid)">${esc(e.field)}</td>
        <td style="font-size:11px;color:var(--text-light)">${esc(e.oldVal)}</td>
        <td style="font-size:11px;font-weight:500">${esc(e.newVal)}</td>
        <td style="font-size:12px;font-weight:500">${esc(e.by)}</td>
        <td style="font-size:11px;color:var(--text-mid);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(e.notes)}">${esc(e.notes)}</td>
      </tr>`;
    });
  }
  html += `</tbody></table></div></div>`;
  el.innerHTML = html;
}

function renderRoadmap() {
  const el = document.getElementById('v-roadmap');
  el.innerHTML = `
    <div class="card" style="margin-bottom:16px">
      <div class="card-body">
        <h2 style="font-size:18px;font-weight:700;margin:0 0 16px">Implementation Roadmap</h2>
        <div class="phase" style="border-color:var(--danger)">
          <div class="phase-title" style="color:var(--danger)">Phase 1: Q1 2025 ‚Äî Quick Wins</div>
          <div class="phase-desc">GRUH: Automate screens/reports ‚Üí 6‚Üí4 ¬∑ SBB: Factiva AI ‚Üí 6‚Üí4 ¬∑ Marketing: Trade spotting ‚Üí 2‚Üí1</div>
        </div>
        <div class="phase" style="border-color:var(--warn)">
          <div class="phase-title" style="color:var(--warn)">Phase 2: Q2 2025 ‚Äî Optimization</div>
          <div class="phase-desc">10B5-1: Improve LLM ‚Üí 3‚Üí2 ¬∑ Form 144: Automate mappings ‚Üí 3‚Üí2 ¬∑ FIM: AI-assisted ‚Üí 5‚Üí3</div>
        </div>
        <div class="phase" style="border-color:var(--success)">
          <div class="phase-title" style="color:var(--success)">Phase 3: Q3-Q4 2025 ‚Äî Refinement</div>
          <div class="phase-desc">Final optimization across all projects ‚Üí Target 12 total headcount</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h3>Headcount Trajectory</h3></div>
      <div class="table-wrap"><table>
        <thead><tr><th>Project</th><th style="text-align:center">Now</th><th style="text-align:center">Q1</th><th style="text-align:center">Q2</th><th style="text-align:center">Q4 Target</th></tr></thead>
        <tbody>
          ${[['GRUH',6,4,3,2],['10B5-1',3,3,2,2],['Form 144',3,3,2,2],['FIM',5,5,3,2],['SBB',6,4,3,2],['Marketing',2,1,1,1],['CT+SSD',1,1,1,1]].map(([name,...nums]) =>
            `<tr><td style="font-weight:500">${name}</td>${nums.map((n,i) => `<td style="text-align:center;${i===3?'color:var(--success);font-weight:700':''}">${n}</td>`).join('')}</tr>`
          ).join('')}
          <tr style="border-top:2px solid var(--border);background:#f8fafc">
            <td style="font-weight:700">TOTAL</td>
            ${[26,21,15,12].map((n,i) => `<td style="text-align:center;font-weight:700;${i===3?'color:var(--success)':''}">${n}</td>`).join('')}
          </tr>
        </tbody>
      </table></div>
    </div>
  `;
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  loadState();
  render();
});
</script>

<!-- ============================================================ -->
<!-- HTML BODY -->
<!-- ============================================================ -->
<div id="toast" class="toast" style="display:none"></div>

<div class="header">
  <div class="header-top">
    <div>
      <h1>2iQ AI Transition Dashboard</h1>
      <div id="subtitle" class="subtitle"></div>
    </div>
    <button class="export-btn" onclick="exportExcel()">üìä Export Audit Excel</button>
  </div>
  <div class="tabs">
    <button class="tab" data-view="overview" onclick="setView('overview')">üìã Overview</button>
    <button class="tab" data-view="projects" onclick="setView('projects')">üìÅ Projects</button>
    <button class="tab" data-view="personnel" onclick="setView('personnel')">üë• Personnel</button>
    <button class="tab" data-view="audit" onclick="setView('audit')">üìù Audit Log</button>
    <button class="tab" data-view="roadmap" onclick="setView('roadmap')">üó∫Ô∏è Roadmap</button>
  </div>
</div>

<div class="main">
  <div id="v-overview" class="view-section"></div>
  <div id="v-projects" class="view-section"></div>
  <div id="v-personnel" class="view-section"></div>
  <div id="v-audit" class="view-section"></div>
  <div id="v-roadmap" class="view-section"></div>
</div>

</body>
</html>
